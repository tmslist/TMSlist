---
import Layout from '../../layouts/Layout.astro';
import { getAllClinics, getClinicsByMachine } from '../../utils/clinicData';
import { ClinicMachine } from '../../types/clinic';

export async function getStaticPaths() {
  const clinics = getAllClinics();
  // Get all unique machines used across all clinics
  const uniqueMachines = [...new Set(clinics.flatMap(c => c.machines))];
  
  return uniqueMachines.map(machine => {
    // We already have the enum value (string), so we can pass it directly
    const machineClinics = getClinicsByMachine(machine);
    const slug = machine.toLowerCase().replace(/\s+/g, '-');
    
    return {
      params: { slug },
      props: { machineName: machine, machineClinics },
    };
  });
}

const { machineName, machineClinics } = Astro.props;
const title = `${machineName} TMS Therapy Clinics - TMS List`;
---

<Layout title={title}>
  <main class="container mx-auto px-4 py-8">
     <nav class="flex text-sm text-gray-500 mb-6" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="hover:text-gray-900">Home</a>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2">/</span>
            <span class="text-gray-800">Technology</span>
          </div>
        </li>
         <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2">/</span>
            <span class="text-gray-800">{machineName}</span>
          </div>
        </li>
      </ol>
    </nav>

    <div class="bg-indigo-50 rounded-xl p-8 mb-8 text-center">
         <h1 class="text-3xl font-bold text-gray-900 mb-2">{machineName} Clinics</h1>
         <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            Browse all verified clinics using {machineName} technology for TMS therapy.
         </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {machineClinics.map((clinic) => (
        <article class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            <div class="h-48 overflow-hidden">
                <img src={clinic.hero_image_url} alt={clinic.name} class="w-full h-full object-cover" loading="lazy" />
            </div>
             <div class="p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-2">
                    <a href={`/clinic/${clinic.slug}`} class="hover:underline text-indigo-600">{clinic.name}</a>
                </h2>
                <div class="flex items-center mb-3">
                     <span class="text-yellow-500 mr-1">â˜…</span>
                     <span class="font-bold text-gray-900 mr-1">
                        {(typeof clinic.rating === 'number' ? clinic.rating : clinic.rating.aggregate).toFixed(1)}
                     </span>
                     <span class="text-gray-500 text-sm">({clinic.review_count} reviews)</span>
                </div>
                <p class="text-gray-600 mb-1 text-sm">{clinic.city}, {clinic.state}</p>
                 <div class="mt-4 flex justify-between items-center">
                    <div class="flex -space-x-2 overflow-hidden">
                         {clinic.machines.slice(0,3).map(m => (
                             <span class="inline-block px-2 py-0.5 text-[10px] rounded-full bg-indigo-100 text-indigo-800 border-white border ring-1 ring-white">{m}</span>
                         ))}
                    </div>
                    <a href={`/clinic/${clinic.slug}`} class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                        View Profile &rarr;
                    </a>
                 </div>
            </div>
        </article>
      ))}
    </div>
  </main>
</Layout>
