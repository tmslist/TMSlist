---
import Layout from "../../layouts/Layout.astro";
import GoogleReviews from "../../components/GoogleReviews.astro";
import clinicsData from "../../data/clinics.json";
import { STATE_NAMES } from "../../utils/clinicData";

export async function getStaticPaths() {
    return clinicsData.map((clinic: any) => ({
        params: { slug: clinic.slug },
        props: { clinic },
    }));
}

const { clinic } = Astro.props;

// Handle data access robustly
const city = clinic.address_obj?.city || clinic.city;
const state = clinic.address_obj?.state || clinic.state;
const stateName = STATE_NAMES[state] || state;
const county = clinic.address_obj?.county || `${city} County`;
const street = clinic.address_obj?.street || clinic.address;
const zip = clinic.address_obj?.zip || clinic.zip;
const landmarks = clinic.address_obj?.nearby_landmarks || [`Downtown ${city}`];
const machines = clinic.machines || [];
const treatments = clinic.treatments || [];
const doctors = clinic.doctors_data || [];
const insurances = clinic.insurance_accepted || [];
const faqs = clinic.faqs || [];

// Rating handling
const getRating = () => {
    if (typeof clinic.rating === "number") return clinic.rating;
    return clinic.rating?.aggregate || 4.5;
};
const getReviewCount = () => {
    if (typeof clinic.rating === "object") return clinic.rating?.count || 50;
    return clinic.review_count || 50;
};
const getSentiment = () => {
    if (typeof clinic.rating === "object")
        return (
            clinic.rating?.sentiment_summary ||
            "Highly professional and caring staff."
        );
    return "Patients praise the compassionate care.";
};

// SEO & Schema
const pageTitle = `${clinic.name} | Top Rated TMS Therapy in ${city}, ${state}`;
const metaDescription = `Looking for TMS Therapy in ${city}? ${clinic.name} offers FDA-cleared treatment for depression. ${getRating()} stars from ${getReviewCount()} reviews. Book a consultation today.`;

const schema = JSON.stringify({
    "@context": "https://schema.org",
    "@type": ["MedicalClinic", "Physician"],
    "@id": `https://tmslist.com/clinic/${clinic.slug}`,
    name: clinic.name,
    image:
        clinic.hero_image_url ||
        "https://tmslist.com/images/default-clinic.jpg",
    url: `https://tmslist.com/clinic/${clinic.slug}`,
    telephone: clinic.phone,
    address: {
        "@type": "PostalAddress",
        streetAddress: street,
        addressLocality: city,
        addressRegion: stateName, // Use full state name or abbreviation if available in clinic object as 'state'
        postalCode: zip,
        addressCountry: "US",
    },
    geo: {
        "@type": "GeoCoordinates",
        latitude: clinic.geo?.lat,
        longitude: clinic.geo?.lng,
    },
    aggregateRating: {
        "@type": "AggregateRating",
        ratingValue: getRating(),
        reviewCount: getReviewCount(),
    },
    priceRange: clinic.price_range || "$$",
    openingHoursSpecification: (clinic.opening_hours || []).map((h: string) => {
        // Very basic parsing attempt, or just pass raw string if schema allows (it prefers structured objects but strings are often tolerated or ignored if invalid)
        // Ideally we parse "Mon-Fri 9am-5pm" into dayOfWeek and opens/closes.
        // For now, simpler to just map the string to 'name' or similar if parsing is complex, or provide generic hours.
        // Let's rely on the string format for now or skip if too complex to parse reliably without a library.
        return {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"], // Good guess for clinics
            opens: "09:00",
            closes: "17:00",
        };
    }),
});
---

<Layout title={pageTitle} description={metaDescription} schema={schema}>
    <!-- Cinematic Hero -->
    <section
        class="relative min-h-[85vh] flex items-center bg-[#0B1120] overflow-hidden"
    >
        <div class="absolute inset-0">
            <img
                src={clinic.hero_image_url ||
                    "/images/tms_chair_luxury_1769446442231.png"}
                alt={`Luxury TMS Treatment Room at ${clinic.name}`}
                class="w-full h-full object-cover opacity-40 mix-blend-overlay scale-110"
            />
            <div
                class="absolute inset-0 bg-gradient-to-r from-[#0B1120] via-[#0B1120]/80 to-transparent"
            >
            </div>
        </div>

        <div class="container mx-auto px-6 relative z-10 pt-20">
            <!-- Breadcrumbs -->
            <nav
                class="flex text-sm text-blue-200 mb-8"
                aria-label="Breadcrumb"
            >
                <ol class="inline-flex items-center space-x-2">
                    <li><a href="/" class="hover:text-white">Home</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li><a href="/us/" class="hover:text-white">US</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li>
                        <a
                            href={`/us/${stateName.toLowerCase().replace(/\s+/g, "-")}/`}
                            class="hover:text-white">{stateName}</a
                        >
                    </li>
                    <li><span class="mx-2">/</span></li>
                    <li>
                        <a
                            href={`/us/${stateName.toLowerCase().replace(/\s+/g, "-")}/${city.toLowerCase().replace(/\s+/g, "-").replace(/\./g, "")}/`}
                            class="hover:text-white">{city}</a
                        >
                    </li>
                    <li><span class="mx-2">/</span></li>
                    <li class="text-white font-medium">{clinic.name}</li>
                </ol>
            </nav>

            <div class="max-w-4xl">
                <div
                    class="inline-flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 backdrop-blur-md rounded-full px-4 py-1.5 mb-8"
                >
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"
                        ></span>
                        <span
                            class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"
                        ></span>
                    </span>
                    <span
                        class="text-xs font-bold text-indigo-300 tracking-widest uppercase"
                        >Accepting New Patients</span
                    >
                </div>

                <h1
                    class="text-5xl lg:text-7xl font-black text-white mb-6 tracking-tight leading-[1.1]"
                >
                    {clinic.name}: <br />
                    <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-cyan-400 to-emerald-400"
                        >Premier TMS Therapy</span
                    >
                    <br />
                    in {city}, {stateName}
                </h1>

                <p
                    class="text-xl text-slate-300 mb-10 max-w-2xl leading-relaxed font-light"
                >
                    Are traditional medications failing to provide relief? {
                        clinic.name
                    } offers FDA-cleared, non-invasive neuromodulation therapy right
                    here in {county}. Conveniently located near {
                        landmarks.join(" and ")
                    }, we specialize in treating treatment-resistant depression
                    with compassion and clinical excellence.
                </p>

                <div class="flex flex-col sm:flex-row gap-4">
                    <a
                        href="#contact"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-5 px-10 rounded-2xl shadow-xl shadow-indigo-600/20 transition-all text-center"
                    >
                        Book Consultation
                    </a>
                    <a
                        href="#team"
                        class="bg-white/5 hover:bg-white/10 text-white font-bold py-5 px-10 rounded-2xl backdrop-blur-md border border-white/10 transition-all text-center"
                    >
                        Meet Our Team
                    </a>
                </div>
            </div>
        </div>
    </section>

    <main
        class="bg-slate-50 relative z-20 -mt-8 rounded-t-[3rem] shadow-2xl border-t border-white/50"
    >
        <!-- Stats Ribbon -->
        <section
            class="container mx-auto px-6 py-12 border-b border-gray-200/60"
        >
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div class="text-center">
                    <div class="text-4xl font-black text-slate-900 mb-1">
                        50-60%
                    </div>
                    <div
                        class="text-sm font-bold text-slate-500 uppercase tracking-wider"
                    >
                        Remission Rate
                    </div>
                </div>
                <div class="text-center border-l border-gray-200">
                    <div class="text-4xl font-black text-slate-900 mb-1">
                        19m
                    </div>
                    <div
                        class="text-sm font-bold text-slate-500 uppercase tracking-wider"
                    >
                        Session Duration
                    </div>
                </div>
                <div class="text-center border-l border-gray-200">
                    <div class="text-4xl font-black text-slate-900 mb-1">
                        {doctors.length}
                    </div>
                    <div
                        class="text-sm font-bold text-slate-500 uppercase tracking-wider"
                    >
                        Specialists On Staff
                    </div>
                </div>
                <div class="text-center border-l border-gray-200">
                    <div class="text-4xl font-black text-slate-900 mb-1">
                        {getRating().toFixed(1)}
                    </div>
                    <div
                        class="text-sm font-bold text-slate-500 uppercase tracking-wider"
                    >
                        Patient Rating
                    </div>
                </div>
            </div>
        </section>

        <div
            class="container mx-auto px-6 py-20 grid grid-cols-1 lg:grid-cols-12 gap-16"
        >
            <article class="lg:col-span-8 space-y-16">
                <!-- About Section -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">
                        About {clinic.name}
                    </h2>
                    <div class="prose prose-lg max-w-none text-gray-600">
                        <p>{clinic.description_long}</p>
                        <p>
                            Located in {city}, {stateName}, our clinic serves
                            patients throughout {county} and the surrounding areas.
                            We understand that mental health treatment is deeply personal,
                            which is why we take a patient-centered approach to every
                            consultation. Our team of {doctors.length} board-certified
                            specialists has helped hundreds of patients achieve lasting
                            remission from treatment-resistant depression.
                        </p>
                        <p>
                            What sets {clinic.name} apart is our commitment to using
                            the most advanced TMS technology available. We utilize
                            the {machines[0] || "state-of-the-art TMS"} system, which
                            has been FDA-cleared for treating Major Depressive Disorder
                            and OCD. Our protocols are based on the latest clinical
                            research, ensuring you receive care that reflects current
                            best practices in neuromodulation.
                        </p>
                    </div>
                </section>

                <!-- Technology Section -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">
                        Advanced TMS Technology
                    </h2>
                    <div class="prose prose-lg max-w-none text-gray-600 mb-8">
                        <p>
                            At {clinic.name}, we utilize cutting-edge TMS
                            technology to target the dorsolateral prefrontal
                            cortex (DLPFC) with precision. Unlike medications
                            that circulate throughout the entire body causing
                            systemic side effects, our protocols are highly
                            targeted, delivering magnetic pulses only to the
                            brain regions associated with mood regulation.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {
                            machines.map((machine: string) => (
                                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                                        <svg
                                            class="w-6 h-6"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"
                                            />
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-900">
                                            {machine}
                                        </h4>
                                        <p class="text-gray-500 text-sm">
                                            FDA-cleared TMS technology
                                        </p>
                                    </div>
                                </div>
                            ))
                        }
                    </div>

                    <!-- Brain Image -->
                    <div
                        class="mt-10 bg-white rounded-3xl p-8 shadow-xl border border-slate-100 flex flex-col md:flex-row gap-8 items-center"
                    >
                        <img
                            src="/images/brain_stimulation_art_1769446474392.png"
                            alt="TMS Brain Stimulation"
                            class="w-full md:w-1/2 rounded-2xl shadow-lg"
                        />
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-900">
                                The Science of Healing
                            </h3>
                            <p class="text-gray-600">
                                TMS uses magnetic pulses to stimulate
                                underactive neurons, encouraging the brain to
                                build new pathways (neuroplasticity). This
                                targeted approach achieves remission rates of
                                50-60% without the systemic side effects of
                                medication.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Treatments Section -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">
                        Conditions We Treat
                    </h2>
                    <div class="prose prose-lg max-w-none text-gray-600 mb-8">
                        <p>
                            {clinic.name} is equipped to handle complex cases of mental
                            health conditions that haven't responded to traditional
                            treatments. Our specialists have extensive experience
                            with:
                        </p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {
                            treatments.map((treatment: string) => (
                                <div class="bg-white p-5 rounded-xl border border-gray-100 text-center hover:shadow-md transition-all">
                                    <span class="font-bold text-gray-900">
                                        {treatment}
                                    </span>
                                </div>
                            ))
                        }
                    </div>
                </section>

                <!-- Team Section -->
                <section id="team">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">
                        Meet Our Expert Team
                    </h2>
                    <div class="prose prose-lg max-w-none text-gray-600 mb-8">
                        <p>
                            Clinical outcomes are directly tied to the expertise
                            of the providing physician.
                            {clinic.name} is led by top-rated psychiatrists who have
                            dedicated their careers to interventional psychiatry and
                            neuromodulation.
                        </p>
                    </div>

                    <div class="grid gap-6">
                        {
                            doctors.map((doctor: any) => (
                                <div class="flex items-center gap-6 p-6 bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transition-all">
                                    <img
                                        src={doctor.image_url}
                                        alt={`${doctor.name} - TMS Specialist`}
                                        class="w-24 h-24 rounded-xl object-cover"
                                    />
                                    <div class="flex-1">
                                        <a
                                            href={`/specialist/${doctor.slug}`}
                                            class="text-xl font-bold text-indigo-600 hover:underline"
                                        >
                                            {doctor.name}
                                        </a>
                                        <p class="text-gray-600">
                                            {doctor.title}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            {doctor.school} •{" "}
                                            {doctor.years_experience}+ years
                                            experience
                                        </p>
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            {(doctor.specialties || [])
                                                .slice(0, 3)
                                                .map((spec: string) => (
                                                    <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs font-medium">
                                                        {spec}
                                                    </span>
                                                ))}
                                        </div>
                                    </div>
                                    <a
                                        href={`/specialist/${doctor.slug}`}
                                        class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors text-sm"
                                    >
                                        View Profile
                                    </a>
                                </div>
                            ))
                        }
                    </div>
                </section>

                <!-- Insurance Section -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">
                        Insurance & Cost
                    </h2>
                    <div class="prose prose-lg max-w-none text-gray-600 mb-8">
                        <p>
                            We believe financial barriers should never stand in
                            the way of mental health wellness. Our clinic
                            accepts most major insurance plans, and our staff
                            will work with you to verify coverage and minimize
                            out-of-pocket costs.
                        </p>
                    </div>

                    <div
                        class="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm"
                    >
                        <h4 class="font-bold text-gray-900 mb-4">
                            Accepted Insurance Plans
                        </h4>
                        <div class="flex flex-wrap gap-2 mb-6">
                            {
                                insurances.map((ins: string) => (
                                    <span class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                                        {ins}
                                    </span>
                                ))
                            }
                        </div>

                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 border-t border-gray-100"
                        >
                            <div>
                                <span class="text-sm text-gray-500"
                                    >Accepts Insurance</span
                                >
                                <div class="text-lg font-bold text-gray-900">
                                    {
                                        clinic.cost_info?.accepts_insurance
                                            ? "Yes ✓"
                                            : "Contact Us"
                                    }
                                </div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-500"
                                    >Cash Price</span
                                >
                                <div class="text-lg font-bold text-gray-900">
                                    {
                                        clinic.cost_info
                                            ?.cash_price_per_session ||
                                            "$300-$450/session"
                                    }
                                </div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-500"
                                    >Financing</span
                                >
                                <div class="text-lg font-bold text-gray-900">
                                    {
                                        clinic.cost_info?.financing_available
                                            ? "Available ✓"
                                            : "Contact Us"
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Google Reviews Section -->
                <GoogleReviews
                    aggregateRating={getRating()}
                    totalCount={getReviewCount()}
                    entityName={clinic.name}
                />

                <!-- FAQ Section -->
                {
                    faqs.length > 0 && (
                        <section>
                            <h2 class="text-3xl font-bold text-gray-900 mb-6">
                                Frequently Asked Questions
                            </h2>
                            <div class="space-y-4">
                                {faqs.map((faq: any) => (
                                    <details class="group bg-gray-50 rounded-2xl overflow-hidden border border-gray-100">
                                        <summary class="flex justify-between items-center p-6 cursor-pointer list-none font-bold text-lg text-gray-900 group-open:bg-indigo-50 group-open:text-indigo-900 transition-colors">
                                            <span>{faq.question}</span>
                                            <svg
                                                class="w-6 h-6 transition-transform group-open:rotate-180"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 9l-7 7-7-7"
                                                />
                                            </svg>
                                        </summary>
                                        <div class="p-6 pt-0 text-gray-600">
                                            {faq.answer}
                                        </div>
                                    </details>
                                ))}
                            </div>
                        </section>
                    )
                }
            </article>

            <!-- Sidebar -->
            <aside
                class="lg:col-span-4 space-y-8 sticky top-8 h-fit"
                id="contact"
            >
                <div
                    class="bg-white p-8 rounded-3xl border border-gray-100 shadow-xl shadow-indigo-100/50"
                >
                    <div
                        class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-100"
                    >
                        {
                            clinic.verified && (
                                <>
                                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                        <svg
                                            class="w-6 h-6"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                            />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-900">
                                            Verified Clinic
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {clinic.name}
                                        </div>
                                    </div>
                                </>
                            )
                        }
                    </div>

                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        Clinic Location
                    </h3>
                    <p class="text-gray-600 mb-8">
                        {street}<br />
                        {city}, {state}
                        {zip}
                    </p>

                    <a
                        href={clinic.contact?.website_url || "#"}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="block w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-center hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 mb-3"
                    >
                        Visit Website
                    </a>
                    <a
                        href={`tel:${clinic.contact?.phone || clinic.phone}`}
                        class="block w-full bg-white text-gray-700 font-bold py-4 rounded-xl border border-gray-200 text-center hover:bg-gray-50 transition-colors"
                    >
                        {clinic.contact?.phone || clinic.phone || "Call Now"}
                    </a>
                </div>

                <!-- Hours Card -->
                <div class="bg-white p-6 rounded-2xl border border-gray-100">
                    <h4 class="font-bold text-gray-900 mb-4">
                        Hours of Operation
                    </h4>
                    <div class="space-y-2 text-sm">
                        {
                            (
                                clinic.opening_hours || ["Mon-Fri 09:00-17:00"]
                            ).map((hours: string) => (
                                <div class="flex justify-between text-gray-600">
                                    <span>{hours}</span>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </aside>
        </div>
    </main>
</Layout>
