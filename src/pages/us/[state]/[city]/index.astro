---
import Layout from "../../../../layouts/Layout.astro";
import ClinicCard from "../../../../components/ClinicCard.astro";
import {
  getUniqueStates,
  getClinicsByState,
  getClinicsByCity,
  getStateSlug,
  STATE_NAMES,
} from "../../../../utils/dataHelpers";
import { calculateClinicScore } from "../../../../utils/ranking";
import { ClinicMachine, ClinicInsurance } from "../../../../types/clinic";

export async function getStaticPaths() {
  const paths = [];
  const uniqueStates = getUniqueStates();

  uniqueStates.forEach((stateCode) => {
    const stateClinics = getClinicsByState(stateCode);
    const uniqueCities = [
      ...new Set(stateClinics.map((c) => c.city).filter(Boolean)),
    ];
    const stateSlug = getStateSlug(stateCode);
    const stateName = STATE_NAMES[stateCode] || stateCode;

    uniqueCities.forEach((cityName) => {
      const citySlug = cityName.toLowerCase().replace(/\s+/g, "-");
      // Using helper for consistency
      const cityClinics = getClinicsByCity(stateCode, cityName);

      paths.push({
        params: { state: stateSlug, city: citySlug },
        props: { stateName, cityName, cityClinics },
      });
    });
  });

  return paths;
}

const { stateName, cityName, cityClinics } = Astro.props;
const { state } = Astro.params;

// Apply Ranking Logic
const sortedClinics = [...cityClinics].sort(
  (a, b) => calculateClinicScore(b) - calculateClinicScore(a),
);

// Strict SEO: "TMS Therapy in [City], [State] - Top [Count] Providers"
const title = `TMS Therapy in ${cityName}, ${stateName} - Top ${sortedClinics.length} Providers`;
---

<Layout title={title}>
  <main class="container mx-auto px-4 py-8">
    <nav class="flex text-sm text-gray-500 mb-6" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="hover:text-gray-900">Home</a>
        </li>
        <li class="inline-flex items-center">
          <span class="mx-2">/</span>
          <a href="/us/" class="hover:text-gray-900">United States</a>
        </li>
        <li class="inline-flex items-center">
          <span class="mx-2">/</span>
          <a href={`/us/${state}/`} class="hover:text-gray-900">{stateName}</a>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2">/</span>
            <span class="text-gray-800 font-medium">{cityName}</span>
          </div>
        </li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar Filters -->
      <aside class="w-full lg:w-1/4">
        <div
          class="bg-white p-6 rounded-xl border border-gray-200 sticky top-8 shadow-sm"
        >
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-gray-900">Filters</h2>
            <button
              class="text-sm text-primary hover:text-primary-dark font-medium"
              >Reset</button
            >
          </div>

          <div class="space-y-6">
            <div>
              <h3
                class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3"
              >
                TMS Technology
              </h3>
              <div class="space-y-2">
                {
                  Object.values(ClinicMachine)
                    .slice(0, 4)
                    .map((m) => (
                      <label class="flex items-center space-x-3 cursor-pointer group">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                        />
                        <span class="text-sm text-gray-600 group-hover:text-gray-900">
                          {m}
                        </span>
                      </label>
                    ))
                }
              </div>
            </div>
            <div>
              <h3
                class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3"
              >
                Insurance
              </h3>
              <div class="space-y-2">
                {
                  Object.values(ClinicInsurance)
                    .slice(0, 4)
                    .map((i) => (
                      <label class="flex items-center space-x-3 cursor-pointer group">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                        />
                        <span class="text-sm text-gray-600 group-hover:text-gray-900">
                          {i}
                        </span>
                      </label>
                    ))
                }
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Grid -->
      <div class="w-full lg:w-3/4">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 flex items-baseline">
          {cityName} TMS Clinics
          <span class="text-gray-500 font-medium text-lg ml-3" id="clinic-count"
            >{cityClinics.length} Providers</span
          >
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="clinic-grid">
          {
            sortedClinics.map((clinic) => (
              <div
                class="clinic-item"
                data-machines={(clinic.machines || []).join(",").toLowerCase()}
                data-insurances={(
                  clinic.insurance_accepted ||
                  clinic.insurances ||
                  []
                )
                  .join(",")
                  .toLowerCase()}
              >
                <ClinicCard clinic={clinic} />
              </div>
            ))
          }
        </div>

        <p id="no-results" class="hidden text-center text-gray-500 py-12">
          No clinics match your selected filters. Try adjusting your criteria.
        </p>

        <script is:inline>
          document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll(
              'input[type="checkbox"]',
            );
            const clinicItems = document.querySelectorAll(".clinic-item");
            const clinicCount = document.getElementById("clinic-count");
            const noResults = document.getElementById("no-results");
            const resetBtn = document.querySelector("button");

            function filterClinics() {
              const selectedMachines = [];
              const selectedInsurances = [];

              checkboxes.forEach((cb) => {
                if (cb.checked) {
                  const label = cb.parentElement
                    .querySelector("span")
                    .textContent.trim()
                    .toLowerCase();
                  // Determine if it's machine or insurance based on parent section
                  const section = cb.closest('div[class="space-y-6"]');
                  if (section) {
                    const firstH3 = section.querySelector("h3");
                    if (firstH3 && firstH3.textContent.includes("Technology")) {
                      selectedMachines.push(label);
                    } else if (
                      firstH3 &&
                      firstH3.textContent.includes("Insurance")
                    ) {
                      selectedInsurances.push(label);
                    }
                  }
                }
              });

              let visibleCount = 0;

              clinicItems.forEach((item) => {
                const machines = item.dataset.machines || "";
                const insurances = item.dataset.insurances || "";

                let showByMachine =
                  selectedMachines.length === 0 ||
                  selectedMachines.some((m) => machines.includes(m));
                let showByInsurance =
                  selectedInsurances.length === 0 ||
                  selectedInsurances.some((i) => insurances.includes(i));

                if (showByMachine && showByInsurance) {
                  item.style.display = "";
                  visibleCount++;
                } else {
                  item.style.display = "none";
                }
              });

              clinicCount.textContent = `${visibleCount} Provider${visibleCount !== 1 ? "s" : ""}`;
              noResults.classList.toggle("hidden", visibleCount > 0);
            }

            checkboxes.forEach((cb) =>
              cb.addEventListener("change", filterClinics),
            );

            resetBtn?.addEventListener("click", () => {
              checkboxes.forEach((cb) => (cb.checked = false));
              filterClinics();
            });
          });
        </script>

        <!-- Interactive Map -->
        <div
          id="clinic-map"
          class="mt-12 rounded-xl h-80 shadow-lg border border-gray-200 overflow-hidden z-0"
        >
        </div>

        <!-- Leaflet CSS -->
        <link
          rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""
        />

        <script
          is:inline
          define:vars={{
            clinicsForMap: sortedClinics
              .filter((c) => c.geo?.lat && c.geo?.lng)
              .map((c) => ({
                name: c.name,
                lat: c.geo.lat,
                lng: c.geo.lng,
                slug: c.slug,
              })),
          }}
        >
          window.addEventListener("load", () => {
            if (typeof L === "undefined") {
              const script = document.createElement("script");
              script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
              script.onload = initMap;
              document.head.appendChild(script);
            } else {
              initMap();
            }

            function initMap() {
              const mapEl = document.getElementById("clinic-map");
              if (!mapEl || clinicsForMap.length === 0) return;

              const firstClinic = clinicsForMap[0];
              const map = L.map("clinic-map").setView(
                [firstClinic.lat, firstClinic.lng],
                11,
              );

              L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
                  attribution: "&copy; OpenStreetMap contributors",
                },
              ).addTo(map);

              clinicsForMap.forEach((clinic) => {
                L.marker([clinic.lat, clinic.lng])
                  .addTo(map)
                  .bindPopup(
                    `<strong>${clinic.name}</strong><br/><a href="/clinic/${clinic.slug}">View Clinic</a>`,
                  );
              });

              // Fit bounds to all markers
              if (clinicsForMap.length > 1) {
                const bounds = L.latLngBounds(
                  clinicsForMap.map((c) => [c.lat, c.lng]),
                );
                map.fitBounds(bounds, { padding: [30, 30] });
              }
            }
          });
        </script>
      </div>
    </div>
  </main>
</Layout>
