---
import Layout from '../../../../../layouts/Layout.astro';
import { getOperationalClinics, getStateSlug, STATE_NAMES } from '../../../../../utils/dataHelpers';


export async function getStaticPaths() {
    const clinics = getOperationalClinics();
    
    // Group by state -> city
    const stateCity = new Map<string, Set<string>>();
    clinics.forEach(c => {
        if (!c.state || !c.city) return; // Skip invalid entries
        if (!stateCity.has(c.state)) stateCity.set(c.state, new Set());
        stateCity.get(c.state)!.add(c.city);
    });
    
    const paths: any[] = [];
    stateCity.forEach((cities, stateCode) => {
        const stateSlug = getStateSlug(stateCode);
        cities.forEach(city => {
            const citySlug = city.toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
            const cityClinics = clinics.filter(c => c.state === stateCode && c.city === city);
            
            if (cityClinics.length > 0) {
                paths.push({
                    params: { state: stateSlug, city: citySlug },
                    props: { 
                        stateCode, 
                        stateName: STATE_NAMES[stateCode], 
                        cityName: city, 
                        clinics: cityClinics
                    }
                });
            }
        });
    });
    
    return paths;
}

const { stateCode, stateName, cityName, clinics: cityClinics } = Astro.props;
const title = `TMS Clinics in ${cityName}, ${stateName} | Find Treatment Centers Near You`;
const description = `Compare ${cityClinics.length} TMS therapy clinics in ${cityName}, ${stateName}. View ratings, insurance accepted, and treatment options.`;

const getRating = (clinic: any) => typeof clinic.rating === 'number' ? clinic.rating : clinic.rating?.aggregate || 4.5;
---

<Layout title={title}>
    <main class="bg-gray-50 min-h-screen">
        <!-- Hero Section -->
        <section class="bg-gradient-to-br from-slate-900 via-indigo-900 to-blue-900 py-20">
            <div class="container mx-auto px-6">
                <nav class="flex text-sm text-blue-200 mb-8" aria-label="Breadcrumb">
                    <ol class="inline-flex items-center space-x-2">
                        <li><a href="/" class="hover:text-white">Home</a></li>
                        <li><span class="mx-2">/</span></li>
                        <li><a href="/us/" class="hover:text-white">US</a></li>
                        <li><span class="mx-2">/</span></li>
                        <li><a href={`/us/${Astro.params.state}/`} class="hover:text-white">{stateName}</a></li>
                        <li><span class="mx-2">/</span></li>
                        <li><a href={`/us/${Astro.params.state}/${Astro.params.city}/`} class="hover:text-white">{cityName}</a></li>
                        <li><span class="mx-2">/</span></li>
                        <li class="text-white font-medium">Clinics</li>
                    </ol>
                </nav>
                
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-white mb-6">
                    TMS <span class="text-cyan-400">Clinics</span> in {cityName}
                </h1>
                <p class="text-xl text-blue-100 max-w-3xl mb-8">
                    Compare {cityClinics.length} FDA-cleared TMS therapy clinics in {cityName}, {stateName}. 
                    View ratings, technology, insurance accepted, and book consultations.
                </p>
                
                <div class="flex flex-wrap gap-4">
                    <a href={`/us/${Astro.params.state}/${Astro.params.city}/psychiatrists/`} class="px-6 py-3 bg-white/10 backdrop-blur border border-white/20 rounded-xl text-white font-medium hover:bg-white/20 transition-all">
                        View Psychiatrists →
                    </a>
                </div>
            </div>
        </section>

        <!-- Stats Bar -->
        <section class="bg-white border-b border-gray-100 py-6">
            <div class="container mx-auto px-6">
                <div class="flex flex-wrap justify-center gap-8 md:gap-16">
                    <div class="text-center">
                        <div class="text-3xl font-black text-indigo-600">{cityClinics.length}</div>
                        <div class="text-sm text-gray-500 font-medium">TMS Clinics</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-black text-indigo-600">{cityClinics.reduce((acc: number, c: any) => acc + (c.doctors_data?.length || 0), 0)}</div>
                        <div class="text-sm text-gray-500 font-medium">Specialists</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-black text-indigo-600">{cityClinics.filter((c: any) => c.verified).length}</div>
                        <div class="text-sm text-gray-500 font-medium">Verified</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Clinics Grid -->
        <section class="py-16">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-10">All TMS Clinics in {cityName}</h2>
                
                <div class="space-y-6">
                    {cityClinics.map((clinic: any, index: number) => (
                        <article class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all">
                            <div class="p-6 md:p-8">
                                <div class="flex flex-col lg:flex-row lg:items-start gap-6">
                                    <!-- Clinic Image -->
                                    <div class="lg:w-64 lg:shrink-0">
                                        <img 
                                            src={clinic.hero_image_url || `https://placehold.co/400x300/e2e8f0/1e293b?text=${clinic.name.split(' ')[0]}`}
                                            alt={clinic.name}
                                            class="w-full h-48 lg:h-40 object-cover rounded-xl"
                                        />
                                    </div>
                                    
                                    <!-- Clinic Info -->
                                    <div class="flex-1">
                                        <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
                                            <div>
                                                <div class="flex items-center gap-2 mb-2">
                                                    {clinic.verified && (
                                                        <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">✓ Verified</span>
                                                    )}
                                                    <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-bold rounded-full">#{index + 1} in {cityName}</span>
                                                </div>
                                                <h3 class="text-2xl font-bold text-gray-900 hover:text-indigo-600 transition-colors">
                                                    <a href={`/clinic/${clinic.slug}`}>{clinic.name}</a>
                                                </h3>
                                                <p class="text-gray-500">{clinic.address}, {clinic.city}, {clinic.state} {clinic.zip}</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-2xl font-black text-gray-900">{getRating(clinic).toFixed(1)}</span>
                                                    <div class="text-yellow-400">★★★★★</div>
                                                </div>
                                                <p class="text-sm text-gray-500">{typeof clinic.rating === 'object' ? clinic.rating.count : clinic.review_count || 50} reviews</p>
                                            </div>
                                        </div>
                                        
                                        <p class="text-gray-600 mb-4 line-clamp-2">{clinic.description_long}</p>
                                        
                                        <div class="flex flex-wrap gap-2 mb-4">
                                            {(clinic.machines || []).slice(0, 3).map((m: string) => (
                                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">{m}</span>
                                            ))}
                                        </div>
                                        
                                        <div class="flex flex-wrap items-center gap-4 pt-4 border-t border-gray-100">
                                            <a href={`/clinic/${clinic.slug}`} class="px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors">
                                                View Clinic
                                            </a>
                                            <a href={`tel:${clinic.contact?.phone || clinic.phone}`} class="px-6 py-2.5 border-2 border-indigo-600 text-indigo-600 font-bold rounded-lg hover:bg-indigo-50 transition-colors">
                                                Call Now
                                            </a>
                                            <span class="text-sm text-gray-500">{(clinic.doctors_data || []).length} specialists on staff</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    ))}
                </div>
            </div>
        </section>

        <!-- SEO Content Section -->
        <section class="py-16 bg-white">
            <div class="container mx-auto px-6 max-w-4xl">
                <h2 class="text-3xl font-bold text-gray-900 mb-8">TMS Therapy in {cityName}, {stateName}</h2>
                
                <div class="prose prose-lg max-w-none text-gray-600">
                    <p>
                        {cityName}, {stateName} is home to {cityClinics.length} FDA-cleared TMS (Transcranial Magnetic Stimulation) therapy clinics, offering advanced treatment options for depression, anxiety, OCD, and other mental health conditions.
                        Our comprehensive directory helps you compare facilities, read verified reviews, and find the right clinic for your needs.
                    </p>
                    
                    <h3 class="text-xl font-bold text-gray-900 mt-8 mb-4">Why Choose TMS Therapy?</h3>
                    <p>
                        TMS therapy offers a non-invasive, FDA-cleared treatment option for those who haven't found relief from medication alone.
                        Unlike ECT (electroconvulsive therapy), TMS requires no anesthesia, has minimal side effects, and allows patients to drive themselves to and from treatment.
                        Clinical studies show remission rates of 50-60% for treatment-resistant depression.
                    </p>
                    
                    <h3 class="text-xl font-bold text-gray-900 mt-8 mb-4">What to Expect at a {cityName} TMS Clinic</h3>
                    <p>
                        Your TMS journey typically begins with a consultation where a psychiatrist evaluates your medical history and treatment goals.
                        If you're a candidate, you'll undergo a brain mapping session to identify the optimal treatment location.
                        Treatment involves 36 sessions over 6-9 weeks, with each session lasting 19-37 minutes depending on the protocol.
                    </p>
                    
                    <h3 class="text-xl font-bold text-gray-900 mt-8 mb-4">Insurance Coverage in {stateName}</h3>
                    <p>
                        Most major insurance providers now cover TMS therapy when medical necessity is demonstrated.
                        Clinics in {cityName} commonly accept Medicare, BlueCross BlueShield, Aetna, Cigna, and UnitedHealthcare.
                        Our clinic profiles show exactly which insurances each facility accepts.
                    </p>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="py-16 bg-gradient-to-r from-indigo-600 to-blue-600">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-3xl font-bold text-white mb-6">Find Your TMS Clinic in {cityName}</h2>
                <p class="text-xl text-blue-100 mb-8 max-w-2xl mx-auto">
                    Compare {cityClinics.length} verified clinics and start your journey to mental wellness today.
                </p>
                <a href="/quiz/am-i-a-candidate/" class="inline-block px-8 py-4 bg-white text-indigo-600 font-bold rounded-xl hover:bg-gray-100 transition-colors shadow-xl">
                    Am I a Candidate?
                </a>
            </div>
        </section>
    </main>
</Layout>
