---
import Layout from "../../../layouts/Layout.astro";
---

<Layout title="Lead Management | TMS List Admin">
    <!-- Login Overlay -->
    <div
        id="login-overlay"
        class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center"
    >
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4"
                >
                    <svg
                        class="w-8 h-8 text-indigo-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        ></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Provider Login</h2>
                <p class="text-gray-600 mt-2">
                    Access your lead management dashboard
                </p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >Username</label
                    >
                    <input
                        type="text"
                        id="login-username"
                        placeholder="admin or doctor name"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >Password</label
                    >
                    <input
                        type="password"
                        id="login-password"
                        placeholder="email address"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    />
                </div>
                <div
                    id="login-error"
                    class="hidden text-red-600 text-sm text-center"
                >
                </div>
                <button
                    type="submit"
                    class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors"
                >
                    Login
                </button>
            </form>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-500 text-center">
                    <strong>Default Admin:</strong> admin / admin@tmslist.com<br
                    />
                    <strong>Doctors:</strong> Your name / Your email
                </p>
            </div>
        </div>
    </div>

    <div class="bg-gray-50 min-h-screen py-12">
        <div class="container mx-auto px-6 max-w-7xl">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-3xl font-black text-gray-900">
                            Enquiry Tracker
                        </h1>
                        <span
                            id="user-badge"
                            class="hidden px-3 py-1 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded-full"
                        ></span>
                    </div>
                    <p class="text-gray-600 mt-1">
                        Manage and track all form submissions
                    </p>
                </div>
                <div class="flex gap-4">
                    <button
                        id="refresh-btn"
                        class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                            ></path>
                        </svg>
                        Refresh
                    </button>
                    <button
                        id="export-btn"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors flex items-center gap-2"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                            ></path>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div class="text-gray-500 text-sm font-medium mb-1">
                        Total Leads
                    </div>
                    <div
                        class="text-3xl font-bold text-gray-900"
                        id="total-count"
                    >
                        -
                    </div>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div class="text-gray-500 text-sm font-medium mb-1">
                        Specialist Enquiries
                    </div>
                    <div
                        class="text-3xl font-bold text-indigo-600"
                        id="specialist-count"
                    >
                        -
                    </div>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div class="text-gray-500 text-sm font-medium mb-1">
                        Lead Magnets
                    </div>
                    <div
                        class="text-3xl font-bold text-blue-600"
                        id="magnet-count"
                    >
                        -
                    </div>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div class="text-gray-500 text-sm font-medium mb-1">
                        Newsletter
                    </div>
                    <div
                        class="text-3xl font-bold text-cyan-600"
                        id="newsletter-count"
                    >
                        -
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8"
            >
                <div
                    class="p-4 border-b border-gray-200 bg-gray-50 flex items-center gap-4 overflow-x-auto"
                >
                    <span class="text-sm font-bold text-gray-500 shrink-0"
                        >Filter:</span
                    >
                    <button
                        class="filter-btn active px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-200 text-gray-800"
                        data-filter="all">All</button
                    >
                    <button
                        class="filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100"
                        data-filter="specialist-enquiry"
                        >Specialist Enquiries</button
                    >
                    <button
                        class="filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100"
                        data-filter="lead-magnet">Lead Magnets</button
                    >
                    <button
                        class="filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100"
                        data-filter="newsletter">Newsletter</button
                    >
                    <button
                        class="filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100"
                        data-filter="quiz-lead">Quiz Leads</button
                    >
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider"
                                    >Date</th
                                >
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider"
                                    >Type</th
                                >
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider"
                                    >Contact</th
                                >
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider"
                                    >Details</th
                                >
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider"
                                    >Source</th
                                >
                            </tr>
                        </thead>
                        <tbody
                            id="leads-table-body"
                            class="divide-y divide-gray-100"
                        >
                            <!-- Rows will be injected here -->
                            <tr>
                                <td
                                    colspan="5"
                                    class="px-6 py-8 text-center text-gray-500"
                                >
                                    Loading data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        interface Lead {
            timestamp: string;
            type: string;
            name?: string;
            email?: string;
            phone?: string;
            source?: string;
            doctorName?: string;
            clinicName?: string;
            message?: string;
            state?: string;
            condition?: string;
            [key: string]: any;
        }

        let allLeads: Lead[] = [];
        let currentUser: { name: string; isAdmin: boolean } | null = null;

        // Check for existing session
        function checkSession() {
            const session = sessionStorage.getItem("tms_leads_session");
            if (session) {
                currentUser = JSON.parse(session);
                showDashboard();
                return true;
            }
            return false;
        }

        // Login handler
        function handleLogin(username: string, password: string): boolean {
            const lowercaseUser = username.toLowerCase().trim();
            const lowercasePass = password.toLowerCase().trim();

            // Admin login
            if (
                lowercaseUser === "admin" &&
                lowercasePass === "admin@tmslist.com"
            ) {
                currentUser = { name: "Admin", isAdmin: true };
                sessionStorage.setItem(
                    "tms_leads_session",
                    JSON.stringify(currentUser),
                );
                return true;
            }

            // Doctor login (name as username, email as password)
            // For simplicity, we'll accept any name/email combo where password contains '@'
            if (password.includes("@")) {
                currentUser = { name: username, isAdmin: false };
                sessionStorage.setItem(
                    "tms_leads_session",
                    JSON.stringify(currentUser),
                );
                return true;
            }

            return false;
        }

        function showDashboard() {
            const overlay = document.getElementById("login-overlay");
            const userBadge = document.getElementById("user-badge");

            if (overlay) overlay.style.display = "none";
            if (userBadge && currentUser) {
                userBadge.textContent = currentUser.isAdmin
                    ? "üëë Admin"
                    : `üë®‚Äç‚öïÔ∏è ${currentUser.name}`;
                userBadge.classList.remove("hidden");
            }
        }

        function logout() {
            sessionStorage.removeItem("tms_leads_session");
            currentUser = null;
            window.location.reload();
        }

        // Fetch leads from API
        async function fetchLeads() {
            const tbody = document.getElementById("leads-table-body");
            if (!tbody) return;

            try {
                tbody.innerHTML =
                    '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Loading data...</td></tr>';

                const response = await fetch("/api/submissions");
                const data = await response.json();

                // Sort by date desc
                allLeads = data.sort(
                    (a, b) =>
                        new Date(b.timestamp).getTime() -
                        new Date(a.timestamp).getTime(),
                );

                updateStats();
                renderTable(allLeads);
            } catch (error) {
                console.error("Error fetching leads:", error);
                tbody.innerHTML =
                    '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading data. Please try again.</td></tr>';
            }
        }

        function renderTable(leads) {
            const tbody = document.getElementById("leads-table-body");
            if (!tbody) return;

            if (leads.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No submissions found.</td></tr>';
                return;
            }

            tbody.innerHTML = leads
                .map(
                    (lead) => `
            <tr class="hover:bg-gray-50 transition-colors group">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(lead.timestamp).toLocaleDateString()}
                    <span class="block text-xs text-gray-400">${new Date(lead.timestamp).toLocaleTimeString()}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2.5 py-1 rounded-full text-xs font-bold ${getTypeColor(lead.type)}">
                        ${formatType(lead.type)}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm font-bold text-gray-900">${lead.name || "N/A"}</div>
                    <div class="text-sm text-gray-500">${lead.email || "No email"}</div>
                    ${lead.phone ? `<div class="text-xs text-gray-400 mt-0.5">${lead.phone}</div>` : ""}
                </td>
                <td class="px-6 py-4 text-sm text-gray-600">
                    ${getDetailsData(lead)}
                </td>
                <td class="px-6 py-4 text-xs text-gray-400 max-w-[200px] truncate" title="${lead.source || ""}">
                    ${formatSource(lead.source)}
                </td>
            </tr>
        `,
                )
                .join("");
        }

        function updateStats() {
            document.getElementById("total-count").textContent =
                allLeads.length.toString();
            document.getElementById("specialist-count").textContent = allLeads
                .filter((l) => l.type === "specialist-enquiry")
                .length.toString();
            document.getElementById("magnet-count").textContent = allLeads
                .filter((l) => l.type === "lead-magnet")
                .length.toString();
            document.getElementById("newsletter-count").textContent = allLeads
                .filter((l) => l.type === "newsletter")
                .length.toString();
        }

        function getTypeColor(type) {
            const colors = {
                "specialist-enquiry": "bg-indigo-100 text-indigo-700",
                "lead-magnet": "bg-blue-100 text-blue-700",
                newsletter: "bg-cyan-100 text-cyan-700",
                "quiz-lead": "bg-purple-100 text-purple-700",
            };
            return colors[type] || "bg-gray-100 text-gray-700";
        }

        function formatType(type) {
            return type
                .split("-")
                .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
        }

        function formatSource(url) {
            if (!url) return "-";
            try {
                const urlObj = new URL(url);
                return urlObj.pathname;
            } catch {
                return url;
            }
        }

        function getDetailsData(lead) {
            if (lead.type === "specialist-enquiry") {
                return `
                <div class="space-y-1">
                    <div class="font-medium text-gray-900">${lead.role || "User"}</div>
                    <p class="line-clamp-2">${lead.message || "No message"}</p>
                </div>
            `;
            } else if (lead.type === "lead-magnet") {
                return `
                <div>
                    Downloaded: <span class="font-medium text-gray-900">${lead.resource || "Unknown Resource"}</span>
                    ${lead.subscribe ? '<div class="text-xs text-green-600 mt-1">‚úì Subscribed to updates</div>' : ""}
                </div>
            `;
            } else if (lead.type === "newsletter") {
                return '<div class="text-green-600 font-medium">Newsletter Signup</div>';
            }
            return JSON.stringify(lead).slice(0, 50) + "...";
        }

        // Filter functionality
        document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const filter = (e.currentTarget as HTMLElement).dataset.filter;

                // Update active state
                document.querySelectorAll(".filter-btn").forEach((b) => {
                    b.classList.remove("bg-gray-200", "text-gray-800");
                    b.classList.add("text-gray-600", "hover:bg-gray-100");
                });
                (e.currentTarget as HTMLElement).classList.remove(
                    "text-gray-600",
                    "hover:bg-gray-100",
                );
                (e.currentTarget as HTMLElement).classList.add(
                    "bg-gray-200",
                    "text-gray-800",
                );

                // Filter data
                if (filter === "all") {
                    renderTable(allLeads);
                } else {
                    renderTable(allLeads.filter((l) => l.type === filter));
                }
            });
        });

        // Refresh button
        document
            .getElementById("refresh-btn")
            ?.addEventListener("click", fetchLeads);

        // Export button
        document.getElementById("export-btn")?.addEventListener("click", () => {
            const headers = [
                "Date",
                "Type",
                "Name",
                "Email",
                "Phone",
                "Details",
                "Source",
            ];
            const csvContent = [
                headers.join(","),
                ...allLeads.map((lead) =>
                    [
                        new Date(lead.timestamp).toLocaleDateString(),
                        lead.type,
                        `"${lead.name || ""}"`,
                        lead.email || "",
                        lead.phone || "",
                        `"${getDetailsData(lead)
                            .replace(/<[^>]*>?/gm, "")
                            .replace(/\s+/g, " ")
                            .trim()}"`,
                        lead.source || "",
                    ].join(","),
                ),
            ].join("\n");

            const blob = new Blob([csvContent], {
                type: "text/csv;charset=utf-8;",
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `leads_export_${new Date().toISOString().split("T")[0]}.csv`;
            link.click();
        });

        // Login form handler
        document
            .getElementById("login-form")
            ?.addEventListener("submit", (e) => {
                e.preventDefault();
                const username = (
                    document.getElementById(
                        "login-username",
                    ) as HTMLInputElement
                )?.value;
                const password = (
                    document.getElementById(
                        "login-password",
                    ) as HTMLInputElement
                )?.value;
                const errorDiv = document.getElementById("login-error");

                if (handleLogin(username, password)) {
                    showDashboard();
                    fetchLeads();
                } else {
                    if (errorDiv) {
                        errorDiv.textContent =
                            "Invalid credentials. Please try again.";
                        errorDiv.classList.remove("hidden");
                    }
                }
            });

        // Initialize - check session
        if (checkSession()) {
            fetchLeads();
        }
    </script>
</Layout>
